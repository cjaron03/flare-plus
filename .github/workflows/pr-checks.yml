name: pull request checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: check commit message format
        run: |
          git log origin/main..HEAD --format=%s | while read msg; do
            # skip merge commits (they start with "Merge")
            if echo "$msg" | grep -qE '^Merge '; then
              continue
            fi
            if echo "$msg" | grep -E '^[A-Z]' > /dev/null; then
              echo "error: commit message should be lowercase: '$msg'"
              exit 1
            fi
          done
      
      - name: check for large files
        run: |
          find . -type f -size +5M | grep -v '.git' | while read file; do
            echo "error: large file detected: $file"
            exit 1
          done || true
      
      - name: setup python and deps
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.10'
          install-dev: 'false'
      
      - name: check for syntax errors
        run: find src tests -name "*.py" -type f -exec python -m py_compile {} \;

  security-and-quality:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: setup python and deps
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.10'
          install-dev: 'true'
      
      - name: check for known security vulnerabilities
        run: safety check --continue-on-error || echo "security vulnerabilities found, review output"
      
      - name: run bandit security linter
        run: bandit -r src/ -ll -f screen
      
      - name: check code complexity
        run: radon cc src/ -a -nb --total-average
      
      - name: check maintainability index
        run: radon mi src/ -nb -s || true
