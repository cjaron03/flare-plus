#!/bin/bash
# flare+ helper script - wrapper around docker-compose and service management

# enable docker buildkit for faster builds with cache mounts
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

case "$1" in
  up)
    echo "starting all docker services..."
    docker-compose up -d
    echo "services started!"
    echo "postgres: localhost:5432"
    ;;
  down)
    echo "stopping all docker services..."
    docker-compose down
    echo "services stopped"
    ;;
  logs)
    echo "viewing logs (ctrl+c to exit)..."
    docker-compose logs -f
    ;;
  build)
    echo "building docker images..."
    docker-compose build
    echo "build complete"
    ;;
  shell)
    echo "opening shell in app container..."
    docker-compose exec app /bin/bash
    ;;
  db-shell)
    echo "opening psql shell in database container..."
    docker-compose exec postgres psql -U postgres -d flare_prediction
    ;;
  init-db)
    echo "initializing database schema..."
    docker-compose exec app python scripts/init_db.py
    echo "database initialized"
    ;;
  ingest)
    echo "running data ingestion from noaa sources..."
    docker-compose exec app python scripts/run_ingestion.py
    ;;
  api)
    echo "starting flask api server for model serving..."
    echo "api will be available at http://127.0.0.1:5001 (mapped from container port 5000)"
    echo "endpoints: /health, /predict/classification, /predict/survival, /predict/all, /ingest"
    echo "note: this will run in the foreground. use ctrl+c to stop."
    echo ""
    
    # auto-detect models in /app/models
    # classification: must contain "classification" and not contain "survival"
    CLASS_MODEL=$(docker-compose exec -T app sh -c "find /app/models -name '*classification*.joblib' ! -name '*survival*' 2>/dev/null | head -1" | tr -d '\r\n')
    # survival: must contain "survival" and not contain "classification"
    SURVIVAL_MODEL=$(docker-compose exec -T app sh -c "find /app/models -name '*survival*.joblib' ! -name '*classification*' 2>/dev/null | head -1" | tr -d '\r\n')
    
    if [ -n "$CLASS_MODEL" ]; then
      echo "found classification model: $CLASS_MODEL"
      CLASS_ARG="--classification-model $CLASS_MODEL"
    else
      echo "no classification model found in /app/models"
      CLASS_ARG=""
    fi
    
    if [ -n "$SURVIVAL_MODEL" ]; then
      echo "found survival model: $SURVIVAL_MODEL"
      SURVIVAL_ARG="--survival-model $SURVIVAL_MODEL"
    else
      echo "no survival model found in /app/models"
      SURVIVAL_ARG=""
    fi
    
    echo ""
    docker-compose exec -e ADMIN_RUNTIME_TOKEN="${ADMIN_RUNTIME_TOKEN}" app python scripts/run_api_server.py $CLASS_ARG $SURVIVAL_ARG
    ;;
  api-stop)
    echo "stopping api server..."
    docker-compose exec app pkill -f "run_api_server.py" || echo "api server not running"
    ;;
  api-bg)
    echo "starting flask api server in background..."
    echo "api will be available at http://127.0.0.1:5001 (mapped from container port 5000)"
    echo "endpoints: /health, /predict/classification, /predict/survival, /predict/all, /ingest"
    echo "use './flare api-stop' to stop the server"
    
    # auto-detect models in /app/models
    # classification: must contain "classification" and not contain "survival"
    CLASS_MODEL=$(docker-compose exec -T app sh -c "find /app/models -name '*classification*.joblib' ! -name '*survival*' 2>/dev/null | head -1" | tr -d '\r\n')
    # survival: must contain "survival" and not contain "classification"
    SURVIVAL_MODEL=$(docker-compose exec -T app sh -c "find /app/models -name '*survival*.joblib' ! -name '*classification*' 2>/dev/null | head -1" | tr -d '\r\n')
    
    if [ -n "$CLASS_MODEL" ]; then
      echo "found classification model: $CLASS_MODEL"
      CLASS_ARG="--classification-model $CLASS_MODEL"
    else
      CLASS_ARG=""
    fi
    
    if [ -n "$SURVIVAL_MODEL" ]; then
      echo "found survival model: $SURVIVAL_MODEL"
      SURVIVAL_ARG="--survival-model $SURVIVAL_MODEL"
    else
      SURVIVAL_ARG=""
    fi
    
    docker-compose exec -e ADMIN_RUNTIME_TOKEN="${ADMIN_RUNTIME_TOKEN}" app bash -c "nohup python scripts/run_api_server.py $CLASS_ARG $SURVIVAL_ARG > /tmp/api.log 2>&1 &"
    sleep 3
    if docker-compose exec app ps aux | grep -q "[r]un_api_server.py"; then
      echo "api server started in background (check logs with: ./flare api-logs)"
    else
      echo "warning: api server may not have started. check logs: ./flare api-logs"
    fi
    ;;
  api-logs)
    echo "viewing api server logs..."
    if docker-compose exec app test -f /tmp/api.log 2>/dev/null; then
      docker-compose exec app tail -f /tmp/api.log
    else
      echo "no api server logs found. is the api server running?"
      echo "checking if api server process is running..."
      docker-compose exec app ps aux | grep "[r]un_api_server.py" || echo "api server process not found"
    fi
    ;;
  ui)
    echo "starting gradio ui dashboard..."
    echo "dashboard will be available at http://127.0.0.1:7860"
    echo "requires api server running (use: ./flare api or ./flare api-bg)"
    echo "note: api is accessible at http://127.0.0.1:5001 from host (5000 inside container)"
    echo "note: this will run in the foreground. use ctrl+c to stop."
    echo ""
    docker-compose exec -e ADMIN_RUNTIME_TOKEN="${ADMIN_RUNTIME_TOKEN}" app python scripts/run_ui.py --api-url http://127.0.0.1:5000
    ;;
  ui-stop)
    echo "stopping ui dashboard..."
    docker-compose exec app pkill -f "run_ui.py" || echo "ui dashboard not running"
    ;;
  ui-bg)
    echo "starting gradio ui dashboard in background..."
    echo "dashboard will be available at http://127.0.0.1:7860"
    echo "requires api server running (use: ./flare api or ./flare api-bg)"
    echo "use './flare ui-stop' to stop the dashboard"
    docker-compose exec -e ADMIN_RUNTIME_TOKEN="${ADMIN_RUNTIME_TOKEN}" app bash -c "nohup python scripts/run_ui.py --api-url http://127.0.0.1:5000 > /tmp/ui.log 2>&1 &"
    sleep 3
    if docker-compose exec app ps aux | grep -q "[r]un_ui.py"; then
      echo "ui dashboard started in background (check logs with: ./flare ui-logs)"
    else
      echo "warning: ui dashboard may not have started. check logs: ./flare ui-logs"
    fi
    ;;
  ui-logs)
    echo "viewing ui dashboard logs..."
    if docker-compose exec app test -f /tmp/ui.log 2>/dev/null; then
      docker-compose exec app tail -f /tmp/ui.log
    else
      echo "no ui dashboard logs found. is the ui dashboard running?"
      echo "checking if ui dashboard process is running..."
      docker-compose exec app ps aux | grep "[r]un_ui.py" || echo "ui dashboard process not found"
    fi
    ;;
  ingest-api)
    echo "triggering data ingestion via api endpoint..."
    echo "note: requires api server running (use: ./flare api or ./flare api-bg)"
    response=$(curl -s -X POST http://127.0.0.1:5001/ingest \
      -H "Content-Type: application/json" \
      -d '{"use_cache": true}')
    if command -v python3 &> /dev/null; then
      echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
    elif command -v python &> /dev/null; then
      echo "$response" | python -m json.tool 2>/dev/null || echo "$response"
    else
      echo "$response"
    fi
    ;;
  test)
    echo "running test suite..."
    docker-compose exec app pytest tests/ -v
    ;;
  lint)
    echo "running linters..."
    docker-compose exec app flake8 src/ tests/
    docker-compose exec app black --check src/ tests/ scripts/
    ;;
  format)
    echo "formatting code with black..."
    docker-compose exec app black src/ tests/ scripts/
    echo "formatting complete"
    ;;
  clean)
    echo "removing containers and volumes..."
    docker-compose down -v
    docker system prune -f
    echo "cleanup complete"
    ;;
  validate)
    echo "running full system validation..."
    docker-compose exec app python scripts/validate_system.py
    ;;
  validate-model)
    if [ -z "$2" ]; then
      echo "error: model path required"
      echo "usage: ./flare validate-model <model-path>"
      echo "example: ./flare validate-model /app/models/survival_model.joblib"
      exit 1
    fi
    echo "validating model: $2"
    docker-compose exec app python scripts/validate_models.py "$2"
    ;;
  check-config)
    echo "checking environment configuration..."
    docker-compose exec app python scripts/check_config.py
    ;;
  *)
    echo "flare+ development helper"
    echo ""
    echo "usage: ./flare <command>"
    echo ""
    echo "docker services:"
    echo "  up         start all docker services (postgres, app)"
    echo "  down       stop all docker services"
    echo "  logs       view logs from all services (ctrl+c to exit)"
    echo "  build      build docker images"
    echo "  shell      open interactive shell in app container"
    echo "  db-shell   open psql shell in database container"
    echo "  clean      remove containers and volumes (cleanup)"
    echo ""
    echo "database:"
    echo "  init-db    initialize database schema"
    echo "  ingest     run data ingestion from noaa sources (direct script)"
    echo ""
    echo "services (api & ui):"
    echo "  api        start flask api server (foreground, http://127.0.0.1:5001)"
    echo "  api-bg     start flask api server in background"
    echo "  api-stop   stop api server"
    echo "  api-logs   view api server logs"
    echo "  ui         start gradio ui dashboard (foreground, http://127.0.0.1:7860)"
    echo "  ui-bg      start gradio ui dashboard in background"
    echo "  ui-stop    stop ui dashboard"
    echo "  ui-logs    view ui dashboard logs"
    echo "  ingest-api trigger data ingestion via api endpoint (requires api running)"
    echo ""
    echo "development:"
    echo "  test       run test suite"
    echo "  lint       run linters (flake8, black check)"
    echo "  format     format code with black"
    echo ""
    echo "validation:"
    echo "  validate             run full system validation"
    echo "  validate-model PATH  validate specific model file"
    echo "  check-config         check environment configuration"
    echo ""
    echo "examples:"
    echo "  ./flare up              # start docker services"
    echo "  ./flare api-bg          # start api server in background"
    echo "  ./flare ui-bg           # start ui dashboard in background"
    echo "  ./flare ingest-api      # trigger ingestion via api"
    echo "  ./flare api-logs        # view api server logs"
    echo "  ./flare validate        # run system validation"
    echo "  ./flare down            # stop all services"
    ;;
esac
