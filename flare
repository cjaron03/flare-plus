#!/bin/bash
# flare+ helper script - wrapper around docker compose and service management

# enable docker buildkit for faster builds with cache mounts
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# color codes for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
GRAY='\033[0;90m'
NC='\033[0m' # no color

# symbols
CHECK="${GREEN}✓${NC}"
CROSS="${RED}✗${NC}"
INFO="${BLUE}ℹ${NC}"
ARROW="${BLUE}→${NC}"

# helper functions
print_header() {
  echo ""
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${BLUE} $1${NC}"
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
}

print_success() {
  echo -e "  ${CHECK} $1"
}

print_error() {
  echo -e "  ${CROSS} $1"
}

print_info() {
  echo -e "  ${INFO} $1"
}

print_url() {
  echo -e "  ${ARROW} $1: ${GREEN}$2${NC}"
}

# check if vite dev server container is running
is_vite_running() {
  docker compose ps ui-dev --format "{{.State}}" 2>/dev/null | grep -q "running"
}

# start vite dev server via docker
start_vite() {
  if is_vite_running; then
    print_info "Vite dev server already running (Docker)"
    return 0
  fi

  print_info "Starting Vite dev server (Docker)..."
  docker compose up -d ui-dev 2>&1 | grep -v "Container.*Running" || true

  # wait for vite to be ready (check logs for "ready" message)
  local max_attempts=30
  local attempt=0
  while [ $attempt -lt $max_attempts ]; do
    if docker compose logs ui-dev 2>&1 | grep -q "VITE.*ready"; then
      print_success "Vite dev server started"
      return 0
    fi
    # also check if container exited with error
    if ! docker compose ps ui-dev --format "{{.State}}" 2>/dev/null | grep -q "running"; then
      print_error "Vite container exited unexpectedly"
      print_info "Check logs with: ./flare dev-logs"
      return 1
    fi
    sleep 1
    attempt=$((attempt + 1))
  done

  # check one more time if it's running
  if is_vite_running; then
    print_success "Vite dev server started"
    return 0
  else
    print_error "Vite dev server failed to start in time"
    print_info "Check logs with: ./flare dev-logs"
    return 1
  fi
}

# stop vite dev server
stop_vite() {
  if is_vite_running; then
    print_info "Stopping Vite dev server..."
    docker compose stop ui-dev 2>/dev/null || true
    print_success "Vite dev server stopped"
  fi
}

case "$1" in
  up)
    print_header "Starting flare+ Development Environment"

    print_info "Starting Docker services..."
    docker compose up -d postgres api ui 2>&1 | grep -v "Container.*Running" || true

    # wait for services to be healthy
    sleep 2

    print_success "Docker services started"

    # start vite dev server
    start_vite

    print_header "Services Ready"
    print_url "Vite Dev (HMR)" "http://localhost:5173"
    print_url "UI Backend" "http://localhost:7860"
    print_url "API Service" "http://localhost:5001"
    print_url "PostgreSQL" "localhost:5432"
    echo ""
    print_info "Use ${BLUE}./flare status${NC} to check service status"
    print_info "Use ${BLUE}./flare dev-logs${NC} to view Vite logs"
    print_info "Use ${BLUE}./flare down${NC} to stop all services"
    echo ""
    ;;

  down)
    print_header "Stopping flare+ Development Environment"

    # stop vite dev server
    stop_vite

    print_info "Stopping Docker services..."
    docker compose down 2>&1 | grep -v "Container.*Stopping\|Container.*Stopped\|Network.*Removing" || true

    print_success "All services stopped"
    echo ""
    ;;

  status)
    print_header "Service Status"

    # check docker services
    echo -e "${BLUE}Docker Services:${NC}"
    if docker compose ps --format "table {{.Service}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null | tail -n +2 | grep -q .; then
      docker compose ps --format "  {{.Service}}: {{.Status}}" 2>/dev/null | tail -n +2
    else
      print_error "No Docker services running"
    fi
    echo ""

    # check vite dev server
    echo -e "${BLUE}Vite Dev Server:${NC}"
    if is_vite_running; then
      print_success "Running (Docker container: ui-dev)"
      print_url "URL" "http://localhost:5173"
    else
      print_error "Not running"
    fi
    echo ""

    # show urls
    echo -e "${BLUE}Available URLs:${NC}"
    if docker compose ps | grep -q "api.*Up"; then
      print_url "API Service" "http://localhost:5001"
    fi
    if docker compose ps | grep -q "ui.*Up"; then
      print_url "UI Backend" "http://localhost:7860"
    fi
    if is_vite_running; then
      print_url "Vite Dev (Live Reload)" "http://localhost:5173"
    fi
    echo ""
    ;;

  dev-logs)
    if ! is_vite_running; then
      print_error "Vite dev server not running. Start with: ./flare up"
      exit 1
    fi
    print_header "Vite Dev Server Logs"
    print_info "Press Ctrl+C to exit"
    echo ""
    docker compose logs -f ui-dev
    ;;

  logs)
    print_header "Docker Service Logs"
    print_info "Press Ctrl+C to exit"
    echo ""
    docker compose logs -f --tail=50
    ;;

  build)
    print_header "Building Docker Images"
    docker compose build
    print_success "Build complete"
    echo ""
    ;;

  shell)
    print_info "Opening shell in app container..."
    docker compose exec app /bin/bash
    ;;

  db-shell)
    print_info "Opening psql shell in database container..."
    docker compose exec postgres psql -U postgres -d flare_prediction
    ;;

  init-db)
    print_info "Initializing database schema..."
    docker compose exec app python scripts/init_db.py
    print_success "Database initialized"
    ;;

  ingest)
    print_header "Data Ingestion"
    print_info "Running data ingestion from NOAA sources..."
    docker compose run --rm ingestion
    ;;

  api)
    API_HOST_PORT="${API_HOST_PORT:-5001}"
    print_header "Starting API Service (Foreground)"
    print_url "API" "http://127.0.0.1:${API_HOST_PORT}"
    print_info "Press Ctrl+C to stop"
    echo ""
    docker compose up api
    ;;

  api-stop)
    print_info "Stopping API service..."
    docker compose stop api >/dev/null 2>&1 || true
    print_success "API service stopped"
    ;;

  api-bg)
    API_HOST_PORT="${API_HOST_PORT:-5001}"
    print_info "Starting API service in background..."
    docker compose up -d api 2>&1 | grep -v "Container.*Running" || true
    sleep 1
    print_success "API service started"
    print_url "API" "http://127.0.0.1:${API_HOST_PORT}"
    ;;

  api-logs)
    print_header "API Service Logs"
    print_info "Press Ctrl+C to exit"
    echo ""
    docker compose logs -f --tail=50 api
    ;;

  ui)
    UI_HOST_PORT="${UI_HOST_PORT:-7860}"
    print_header "Starting UI Backend (Foreground)"
    print_url "UI Backend" "http://127.0.0.1:${UI_HOST_PORT}"
    print_info "Press Ctrl+C to stop"
    echo ""
    docker compose up ui
    ;;

  ui-stop)
    print_info "Stopping UI backend..."
    docker compose stop ui >/dev/null 2>&1 || true
    print_success "UI backend stopped"
    ;;

  ui-bg)
    UI_HOST_PORT="${UI_HOST_PORT:-7860}"
    print_info "Starting UI backend in background..."
    docker compose up -d ui 2>&1 | grep -v "Container.*Running" || true
    sleep 1
    print_success "UI backend started"
    print_url "UI Backend" "http://127.0.0.1:${UI_HOST_PORT}"
    ;;

  ui-logs)
    print_header "UI Backend Logs"
    print_info "Press Ctrl+C to exit"
    echo ""
    docker compose logs -f --tail=50 ui
    ;;

  ingest-api)
    API_HOST_PORT="${API_HOST_PORT:-5001}"
    print_header "Triggering Ingestion via API"
    print_info "Requires API service running (use: ./flare api-bg)"
    response=$(curl -s -X POST "http://127.0.0.1:${API_HOST_PORT}/ingest" \
      -H "Content-Type: application/json" \
      -d '{"use_cache": true}')
    echo ""
    if command -v python3 &> /dev/null; then
      echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
    elif command -v python &> /dev/null; then
      echo "$response" | python -m json.tool 2>/dev/null || echo "$response"
    else
      echo "$response"
    fi
    echo ""
    ;;

  test)
    print_header "Running Test Suite"
    docker compose exec app pytest tests/ -v
    ;;

  lint)
    print_header "Running Linters"
    print_info "Running flake8..."
    docker compose exec app flake8 src/ tests/
    print_info "Running black check..."
    docker compose exec app black --check src/ tests/ scripts/
    ;;

  format)
    print_header "Formatting Code"
    docker compose exec app black src/ tests/ scripts/
    print_success "Formatting complete"
    ;;

  clean)
    print_header "Cleanup"
    print_info "Removing containers and volumes..."
    stop_vite
    docker compose down -v
    docker system prune -f
    print_success "Cleanup complete"
    echo ""
    ;;

  backtest)
    shift  # remove 'backtest' from args
    print_header "Historical Backtest"
    docker compose exec app python scripts/backtest_historical.py "$@"
    ;;

  validate)
    print_header "System Validation"
    docker compose exec app python scripts/validate_system.py
    ;;
  
  clear-guardrail)
    print_header "Clear Guardrail Status"
    print_info "Clearing stale guardrail status from latest validation record..."
    docker compose exec app python scripts/clear_guardrail.py
    print_success "Guardrail status cleared. Refresh the UI to see updated confidence."
    ;;

  validate-model)
    if [ -z "$2" ]; then
      print_error "Model path required"
      echo ""
      echo "Usage: ./flare validate-model <model-path>"
      echo "Example: ./flare validate-model /app/models/survival_model.joblib"
      exit 1
    fi
    print_header "Model Validation"
    print_info "Validating: $2"
    docker compose exec app python scripts/validate_models.py "$2"
    ;;

  check-config)
    print_header "Configuration Check"
    docker compose exec app python scripts/check_config.py
    ;;

  import-donki)
    START_DATE="${2:-}"
    END_DATE="${3:-}"
    API_KEY="${4:-${NASA_API_KEY:-DEMO_KEY}}"
    
    print_header "Import DONKI Historical Flares"
    
    if [ -n "$START_DATE" ] && [ -n "$END_DATE" ]; then
      print_info "Importing flares from ${START_DATE} to ${END_DATE}..."
      docker compose exec app python scripts/import_donki_flares.py --start-date "${START_DATE}" --end-date "${END_DATE}" --api-key "${API_KEY}"
    elif [ -n "$START_DATE" ]; then
      print_info "Importing flares from ${START_DATE} to today..."
      docker compose exec app python scripts/import_donki_flares.py --start-date "${START_DATE}" --api-key "${API_KEY}"
    else
      print_info "Importing flares (last 2 years)..."
      docker compose exec app python scripts/import_donki_flares.py --api-key "${API_KEY}"
    fi
    ;;

  *)
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE} flare+ development helper${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}Primary Commands:${NC}"
    echo -e "  ${GREEN}up${NC}           Start all services (Docker + Vite dev server)"
    echo -e "  ${GREEN}down${NC}         Stop all services"
    echo -e "  ${GREEN}status${NC}       Show running services and URLs"
    echo -e "  ${GREEN}logs${NC}         View Docker service logs"
    echo -e "  ${GREEN}dev-logs${NC}     View Vite dev server logs"
    echo ""
    echo -e "${YELLOW}Development:${NC}"
    echo -e "  ${GREEN}build${NC}        Build Docker images"
    echo -e "  ${GREEN}test${NC}         Run test suite"
    echo -e "  ${GREEN}lint${NC}         Run linters (flake8, black)"
    echo -e "  ${GREEN}format${NC}       Format code with black"
    echo -e "  ${GREEN}shell${NC}        Open shell in app container"
    echo ""
    echo -e "${YELLOW}Database:${NC}"
    echo -e "  ${GREEN}init-db${NC}      Initialize database schema"
    echo -e "  ${GREEN}ingest${NC}       Run data ingestion from NOAA"
    echo -e "  ${GREEN}import-donki${NC} [START] [END] [API_KEY]  Import historical flares from NASA DONKI"
    echo -e "  ${GREEN}db-shell${NC}     Open psql shell"
    echo ""
    echo -e "${YELLOW}Services (Individual Control):${NC}"
    echo -e "  ${GREEN}api${NC}          Start API (foreground)"
    echo -e "  ${GREEN}api-bg${NC}       Start API (background)"
    echo -e "  ${GREEN}api-stop${NC}     Stop API"
    echo -e "  ${GREEN}api-logs${NC}     View API logs"
    echo -e "  ${GREEN}ui${NC}           Start UI backend (foreground)"
    echo -e "  ${GREEN}ui-bg${NC}        Start UI backend (background)"
    echo -e "  ${GREEN}ui-stop${NC}      Stop UI backend"
    echo -e "  ${GREEN}ui-logs${NC}      View UI logs"
    echo ""
    echo -e "${YELLOW}Validation:${NC}"
    echo -e "  ${GREEN}validate${NC}     Run full system validation"
    echo -e "  ${GREEN}validate-model${NC} <path>  Validate specific model"
    echo -e "  ${GREEN}check-config${NC} Check environment configuration"
    echo -e "  ${GREEN}backtest${NC}     Run historical backtest"
    echo ""
    echo -e "${YELLOW}Quick Start:${NC}"
    echo -e "  ${GRAY}./flare up${NC}         # Start everything"
    echo -e "  ${GRAY}./flare status${NC}     # Check what's running"
    echo -e "  ${GRAY}./flare ingest${NC}     # Load data"
    echo -e "  ${GRAY}./flare import-donki${NC}  # Import historical flares"
    echo -e "  ${GRAY}./flare down${NC}       # Stop everything"
    echo ""
    echo -e "${YELLOW}URLs (when running):${NC}"
    echo -e "  ${GRAY}Vite Dev (HMR):${NC}    http://localhost:5173"
    echo -e "  ${GRAY}UI Backend:${NC}        http://localhost:7860"
    echo -e "  ${GRAY}API Service:${NC}       http://localhost:5001"
    echo ""
    ;;
esac
