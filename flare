#!/bin/bash
# flare+ helper script - wrapper around docker-compose and service management

# enable docker buildkit for faster builds with cache mounts
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

case "$1" in
  up)
    echo "starting core docker services (postgres, app)..."
    docker-compose up -d postgres app
    echo "services started!"
    echo "postgres: localhost:${DB_PORT:-5432}"
    echo "tip: use './flare ingest' to load data, './flare api-bg' to expose the api, './flare ui-bg' for the dashboard"
    ;;
  down)
    echo "stopping all docker services..."
    docker-compose down
    echo "services stopped"
    ;;
  logs)
    echo "viewing logs (ctrl+c to exit)..."
    docker-compose logs -f
    ;;
  build)
    echo "building docker images..."
    docker-compose build
    echo "build complete"
    ;;
  shell)
    echo "opening shell in app container..."
    docker-compose exec app /bin/bash
    ;;
  db-shell)
    echo "opening psql shell in database container..."
    docker-compose exec postgres psql -U postgres -d flare_prediction
    ;;
  init-db)
    echo "initializing database schema..."
    docker-compose exec app python scripts/init_db.py
    echo "database initialized"
    ;;
  ingest)
    echo "running data ingestion from noaa sources (one-off container)..."
    docker-compose run --rm ingestion
    ;;
  api)
    API_HOST_PORT="${API_HOST_PORT:-5001}"
    echo "starting flask api service (foreground)..."
    echo "api will be available at http://127.0.0.1:${API_HOST_PORT}"
    echo "press ctrl+c to stop (or use ./flare api-stop)"
    docker-compose up api
    ;;
  api-stop)
    echo "stopping api service..."
    docker-compose stop api >/dev/null || true
    ;;
  api-bg)
    API_HOST_PORT="${API_HOST_PORT:-5001}"
    echo "starting flask api service in background..."
    docker-compose up -d api
    echo "api running at http://127.0.0.1:${API_HOST_PORT} (container port ${API_PORT:-5000})"
    echo "use './flare api-stop' to stop the service"
    ;;
  api-logs)
    echo "streaming api logs (ctrl+c to exit)..."
    docker-compose logs -f api
    ;;
  ui)
    UI_HOST_PORT="${UI_HOST_PORT:-7860}"
    echo "starting gradio ui dashboard (foreground)..."
    echo "dashboard will be available at http://127.0.0.1:${UI_HOST_PORT}"
    echo "press ctrl+c to stop (or use ./flare ui-stop)"
    docker-compose up ui
    ;;
  ui-stop)
    echo "stopping ui dashboard..."
    docker-compose stop ui >/dev/null || true
    ;;
  ui-bg)
    UI_HOST_PORT="${UI_HOST_PORT:-7860}"
    echo "starting gradio ui dashboard in background..."
    docker-compose up -d ui
    echo "dashboard running at http://127.0.0.1:${UI_HOST_PORT}"
    echo "use './flare ui-stop' to stop the service"
    ;;
  ui-logs)
    echo "streaming ui logs (ctrl+c to exit)..."
    docker-compose logs -f ui
    ;;
  ingest-api)
    API_HOST_PORT="${API_HOST_PORT:-5001}"
    echo "triggering data ingestion via api endpoint..."
    echo "note: requires api service running (./flare api-bg)"
    response=$(curl -s -X POST "http://127.0.0.1:${API_HOST_PORT}/ingest" \
      -H "Content-Type: application/json" \
      -d '{"use_cache": true}')
    if command -v python3 &> /dev/null; then
      echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
    elif command -v python &> /dev/null; then
      echo "$response" | python -m json.tool 2>/dev/null || echo "$response"
    else
      echo "$response"
    fi
    ;;
  test)
    echo "running test suite..."
    docker-compose exec app pytest tests/ -v
    ;;
  lint)
    echo "running linters..."
    docker-compose exec app flake8 src/ tests/
    docker-compose exec app black --check src/ tests/ scripts/
    ;;
  format)
    echo "formatting code with black..."
    docker-compose exec app black src/ tests/ scripts/
    echo "formatting complete"
    ;;
  clean)
    echo "removing containers and volumes..."
    docker-compose down -v
    docker system prune -f
    echo "cleanup complete"
    ;;
  backtest)
    shift  # remove 'backtest' from args
    echo "running historical backtest..."
    docker-compose exec app python scripts/backtest_historical.py "$@"
    ;;
  validate)
    echo "running full system validation..."
    docker-compose exec app python scripts/validate_system.py
    ;;
  validate-model)
    if [ -z "$2" ]; then
      echo "error: model path required"
      echo "usage: ./flare validate-model <model-path>"
      echo "example: ./flare validate-model /app/models/survival_model.joblib"
      exit 1
    fi
    echo "validating model: $2"
    docker-compose exec app python scripts/validate_models.py "$2"
    ;;
  check-config)
    echo "checking environment configuration..."
    docker-compose exec app python scripts/check_config.py
    ;;
  *)
    echo "flare+ development helper"
    echo ""
    echo "usage: ./flare <command>"
    echo ""
    echo "docker services:"
    echo "  up         start core services (postgres + app toolbox container)"
    echo "  down       stop all docker services"
    echo "  logs       view logs from all services (ctrl+c to exit)"
    echo "  build      build docker images"
    echo "  shell      open interactive shell in app container"
    echo "  db-shell   open psql shell in database container"
    echo "  clean      remove containers and volumes (cleanup)"
    echo ""
    echo "database:"
    echo "  init-db    initialize database schema"
    echo "  ingest     run data ingestion (one-off container, retries on failure)"
    echo ""
    echo "services (api & ui):"
    echo "  api        start flask api service (foreground, default http://127.0.0.1:5001)"
    echo "  api-bg     start flask api service in background"
    echo "  api-stop   stop api service"
    echo "  api-logs   stream api logs"
    echo "  ui         start gradio ui dashboard (foreground, default http://127.0.0.1:7860)"
    echo "  ui-bg      start ui dashboard in background"
    echo "  ui-stop    stop ui dashboard"
    echo "  ui-logs    stream ui logs"
    echo "  ingest-api trigger ingestion via api endpoint (requires api-bg)"
    echo ""
    echo "development:"
    echo "  test       run test suite"
    echo "  lint       run linters (flake8, black check)"
    echo "  format     format code with black"
    echo ""
    echo "validation:"
    echo "  validate             run full system validation"
    echo "  validate-model PATH  validate specific model file"
    echo "  check-config         check environment configuration"
    echo "  backtest [OPTIONS]   run historical backtesting (see --help for options)"
    echo ""
    echo "examples:"
    echo "  ./flare up              # start postgres + toolbox container"
    echo "  ./flare ingest          # populate database via ingestion service"
    echo "  ./flare api-bg          # start api service in background"
    echo "  ./flare ui-bg           # start ui dashboard in background"
    echo "  ./flare ingest-api      # trigger ingestion via running api"
    echo "  ./flare api-logs        # stream api service logs"
    echo "  ./flare validate        # run system validation"
    echo "  ./flare down            # stop all services"
    ;;
esac
